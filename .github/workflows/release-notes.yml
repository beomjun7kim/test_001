name: Update Release Notes

on:
  release:
    types: [created, published]
  push:
    tags:
      - 'v*'

jobs:
  update-notes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update GitHub release body from CHANGELOG.md
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const tagRef = process.env.GITHUB_REF || '';
            const tag = tagRef.startsWith('refs/tags/')
              ? tagRef.replace('refs/tags/', '')
              : (context.payload && context.payload.release && context.payload.release.tag_name) || null;
            if (!tag) core.setFailed('Tag name not found in context');

            let changelog = '';
            try {
              changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            } catch (e) {
              core.setFailed('CHANGELOG.md not found');
            }

            // Try to extract the section for this tag: header like '## [vX.Y.Z]'
            function escapeRegExp(string) {
              return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            const pattern = new RegExp(`## \[${escapeRegExp(tag)}\][\\s\\S]*?(?=\\n## \\[|$)`, 'm');
            const m = changelog.match(pattern);
            const notes = m ? m[0] : changelog;

            const releases = await github.rest.repos.listReleases({ owner: context.repo.owner, repo: context.repo.repo });
            const rel = releases.data.find(r => r.tag_name === tag);
            if (!rel) core.setFailed(`Release for tag ${tag} not found`);

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: rel.id,
              body: notes,
            });
